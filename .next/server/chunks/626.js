"use strict";exports.id=626,exports.ids=[626],exports.modules={64626:(a,b,c)=>{c.d(b,{UB:()=>l,gI:()=>m,ly:()=>j,wt:()=>h,y8:()=>i,y_:()=>k});var d=c(36241);class e{async init(){try{if(!localStorage.getItem("auth_token")){console.warn("‚ö†Ô∏è Nenhum token de autentica\xe7\xe3o encontrado, usando armazenamento local"),this.useBackend=!1,await this.localStorage.init();return}console.log("\uD83D\uDD04 Tentando conectar ao backend PostgreSQL..."),await d.yM.list(),this.useBackend=!0,console.log("‚úÖ Usando backend PostgreSQL para armazenamento")}catch(a){console.error("‚ùå Erro ao conectar com backend:",a),console.warn("‚ö†Ô∏è Backend n\xe3o dispon\xedvel, usando armazenamento local"),this.useBackend=!1,await this.localStorage.init()}}async saveRelatorio(a){if(console.log("\uD83D\uDCBE Tentando salvar relat\xf3rio:",a.title),console.log("\uD83D\uDD27 Usando backend?",this.useBackend),!this.useBackend)return console.log("\uD83D\uDCBE Salvando localmente (IndexedDB)..."),await this.localStorage.saveRelatorio(a);try{console.log("\uD83D\uDCE4 Enviando para backend PostgreSQL...");let b=this.convertToBackendFormat(a);console.log("\uD83D\uDCCB Dados convertidos:",b);let c=await d.yM.create(b);return console.log("‚úÖ Relat\xf3rio salvo no backend:",c),this.convertFromBackendFormat(c)}catch(b){return console.error("‚ùå Erro ao salvar no backend:",b),console.log("\uD83D\uDD04 Tentando fallback para local..."),await this.localStorage.saveRelatorio(a)}}async getRelatorio(a){if(!this.useBackend)return await this.localStorage.getRelatorio(a);try{let b=await d.yM.getById(a);return this.convertFromBackendFormat(b)}catch(b){return console.error("Erro ao buscar no backend:",b),await this.localStorage.getRelatorio(a)}}async getAllRelatorios(){if(!this.useBackend)return await this.localStorage.getAllRelatorios();try{return(await d.yM.list()).relatorios.map(a=>this.convertFromBackendFormat(a))}catch(a){return console.error("Erro ao listar do backend:",a),await this.localStorage.getAllRelatorios()}}async deleteRelatorio(a){if(this.useBackend)try{await d.yM.delete(a)}catch(b){console.error("Erro ao deletar no backend:",b),await this.localStorage.deleteRelatorio(a)}else await this.localStorage.deleteRelatorio(a)}async listRelatorios(){if(console.log("\uD83D\uDCCB Listando relat\xf3rios..."),console.log("\uD83D\uDD27 Usando backend?",this.useBackend),!this.useBackend)return console.log("\uD83D\uDCE5 Buscando localmente (IndexedDB)..."),await this.localStorage.listRelatorios();try{console.log("\uD83D\uDCE5 Buscando do backend PostgreSQL...");let a=await d.yM.list();return console.log("‚úÖ Relat\xf3rios encontrados no backend:",a.relatorios.length),a.relatorios.map(a=>this.convertToReportSummary(a))}catch(a){return console.error("‚ùå Erro ao buscar no backend:",a),await this.localStorage.listRelatorios()}}async getStorageInfo(){if(!this.useBackend)return await this.localStorage.getStorageInfo();try{return{documentCount:(await d.yM.list()).pagination.total,maxCapacity:"Ilimitado (Backend)",availableCapacity:"Ilimitado (Backend)",usedCapacity:"N/A",percentage:0,storageType:"Backend PostgreSQL"}}catch(a){return console.error("Erro ao obter info do backend:",a),await this.localStorage.getStorageInfo()}}async clearOldReports(a=100){this.useBackend?console.log("Backend gerencia automaticamente o armazenamento"):await this.localStorage.clearOldReports(a)}convertToBackendFormat(a){return{tipo_servico:a.tipoServico,titulo:this.getTitle(a),data_relatorio:this.getDate(a),sub_regiao:this.getSubRegiao(a),local:this.getLocal(a),descricao:this.getDescription(a),dados_jsonb:a}}convertFromBackendFormat(a){return a.dados_jsonb||a}convertToReportSummary(a){let b=this.convertFromBackendFormat(a);return{id:a.id,title:a.titulo||this.getTitle(b),data:a.data_relatorio||this.getDate(b),fotoCount:this.countPhotos(b),tipoServico:a.tipo_servico,sub:a.sub_regiao,endereco:a.local||""}}getTitle(a){return"MUTIRAO"===a.tipoServico?a.title||"Mutir\xe3o":a.tipoServico}getDate(a){if("MUTIRAO"===a.tipoServico);else if("ROTINEIROS"===a.tipoServico);else if("REVITALIZACAO"===a.tipoServico);else if("ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico)return a.dataInicio||"";else if("DDS"===a.tipoServico)return a.dataInicio||"";else if("EVENTOS"===a.tipoServico)return a.dataInicio||"";return a.data||""}getSubRegiao(a){if("MUTIRAO"===a.tipoServico)return a.secoes?.[0]?.sub||"";if("ROTINEIROS"===a.tipoServico)return a.sub||"";if("REVITALIZACAO"===a.tipoServico)return a.sub||"";if("ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico)return a.sub||"";if("DDS"===a.tipoServico)return a.sub||"";else if("EVENTOS"===a.tipoServico)return a.sub||"";return""}getLocal(a){if("MUTIRAO"===a.tipoServico)return a.secoes?.[0]?.local||"";if("REVITALIZACAO"===a.tipoServico)return a.local||"";if("ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico)return a.local||"";if("DDS"===a.tipoServico)return a.local||"";if("EVENTOS"===a.tipoServico)return a.local||"";return""}getDescription(a){if("MUTIRAO"===a.tipoServico)return a.secoes?.[0]?.descricao||"";if("REVITALIZACAO"===a.tipoServico)return a.descricao||"";if("ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico)return a.descricao||"";if("DDS"===a.tipoServico)return a.descricao||"";if("EVENTOS"===a.tipoServico)return a.descricao||"";return""}countPhotos(a){if("MUTIRAO"===a.tipoServico)return a.secoes?.reduce((a,b)=>a+b.servicos?.reduce((a,b)=>a+(b.fotos?.length||0),0)+ +!!b.equipeFotoUrl+ +!!b.mapaFotoUrl,0)||0;if("ROTINEIROS"===a.tipoServico)return a.servicos?.reduce((a,b)=>a+(b.fotos?.length||0),0)||0;if("REVITALIZACAO"===a.tipoServico)return a.fotos?.length||0;if("ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico)return a.fotos?.length||0;if("DDS"===a.tipoServico)return a.fotos?.length||0;else if("EVENTOS"===a.tipoServico)return a.fotos?.length||0;return 0}constructor(){this.useBackend=!0,this.localStorage=new f}}class f{async init(){return new Promise((a,b)=>{let c=indexedDB.open(this.dbName,this.version);c.onerror=()=>b(c.error),c.onsuccess=()=>{this.db=c.result,a()},c.onupgradeneeded=a=>{let b=a.target.result;if(!b.objectStoreNames.contains("relatorios")){let a=b.createObjectStore("relatorios",{keyPath:"id"});a.createIndex("tipoServico","tipoServico",{unique:!1}),a.createIndex("createdAt","createdAt",{unique:!1}),a.createIndex("updatedAt","updatedAt",{unique:!1})}}})}async ensureDB(){return this.db||await this.init(),this.db}async saveRelatorio(a){let b=await this.ensureDB();return new Promise((c,d)=>{let e=b.transaction(["relatorios"],"readwrite").objectStore("relatorios").put({...a,updatedAt:Date.now()});e.onsuccess=()=>c(a),e.onerror=()=>d(e.error)})}async getRelatorio(a){let b=await this.ensureDB();return new Promise((c,d)=>{let e=b.transaction(["relatorios"],"readonly").objectStore("relatorios").get(a);e.onsuccess=()=>c(e.result||null),e.onerror=()=>d(e.error)})}async getAllRelatorios(){let a=await this.ensureDB();return new Promise((b,c)=>{let d=a.transaction(["relatorios"],"readonly").objectStore("relatorios").getAll();d.onsuccess=()=>b(d.result||[]),d.onerror=()=>c(d.error)})}async deleteRelatorio(a){let b=await this.ensureDB();return new Promise((c,d)=>{let e=b.transaction(["relatorios"],"readwrite").objectStore("relatorios").delete(a);e.onsuccess=()=>c(),e.onerror=()=>d(e.error)})}async listRelatorios(){return(await this.getAllRelatorios()).map(a=>{let b="";b="MUTIRAO"===a.tipoServico?a.data||"":"ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico?a.dataInicio||"":"REVITALIZACAO"===a.tipoServico||"ROTINEIROS"===a.tipoServico?a.data||"":a.dataInicio||a.data||"";let c=0;"MUTIRAO"===a.tipoServico?c=a.secoes?.reduce((a,b)=>a+b.servicos?.reduce((a,b)=>a+(b.fotos?.length||0),0)+ +!!b.equipeFotoUrl+ +!!b.mapaFotoUrl,0)||0:"ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico||"REVITALIZACAO"===a.tipoServico?c=a.fotos?.length||0:"ROTINEIROS"===a.tipoServico&&(c=a.servicos?.reduce((a,b)=>a+(b.fotos?.length||0),0)||0);let d={id:a.id,title:{MUTIRAO:"Mutir\xe3o",ACUMULADOR:"Acumulador",ALAGAMENTOS:"Alagamentos",REVITALIZACAO:"Revitaliza\xe7\xe3o",ZELADORIA:"Zeladoria",DDS:"DDS",HIGIENIZACAO:"Higieniza\xe7\xe3o, manuten\xe7\xe3o, instala\xe7\xe3o, remo\xe7\xe3o e reposi\xe7\xe3o de Papeleiras",VARRICAO_MECANIZADA:"Varri\xe7\xe3o Mecanizada",FEIRAS:"Feiras",EVENTOS:"Eventos",ROTINEIROS:"Servi\xe7os Rotineiros",REGISTROS_FOTOGRAFICOS:"Registros Fotogr\xe1ficos"}[a.tipoServico]||a.tipoServico,data:b,createdAt:a.createdAt,updatedAt:a.updatedAt,fotoCount:c};return"MUTIRAO"===a.tipoServico?{...d,tipoServico:a.tipoServico,sub:a.secoes?.[0]?.sub,endereco:a.secoes?.[0]?.local||""}:"ACUMULADOR"===a.tipoServico||"ALAGAMENTOS"===a.tipoServico||"ZELADORIA"===a.tipoServico?{...d,tipoServico:a.tipoServico,sub:a.sub,endereco:a.local||""}:"REVITALIZACAO"===a.tipoServico?{...d,tipoServico:a.tipoServico,sub:a.sub,endereco:a.local||""}:"ROTINEIROS"===a.tipoServico?{...d,tipoServico:a.tipoServico,sub:a.sub,endereco:""}:{...d,tipoServico:a.tipoServico,endereco:""}})}async getStorageInfo(){let a=await this.ensureDB();return new Promise(b=>{let c=a.transaction(["relatorios"],"readonly").objectStore("relatorios").count();c.onsuccess=()=>{navigator.storage.estimate().then(a=>{b({documentCount:c.result,maxCapacity:0x80000000,availableCapacity:a.quota||0,usedCapacity:a.usage||0,percentage:Math.round((a.usage||0)/0x80000000*100),storageType:"Local (IndexedDB)"})})}})}async clearOldReports(a=100){let b=await this.getAllRelatorios();if(b.length<=a)return;let c=b.sort((a,b)=>new Date(b.createdAt).getTime()-new Date(a.createdAt).getTime()).slice(a);for(let a of c)await this.deleteRelatorio(a.id);console.log(`üóëÔ∏è Removidos ${c.length} relat\xf3rios antigos`)}constructor(){this.dbName="RelatoriosDB",this.version=1,this.db=null}}let g=new e,h=async a=>await g.saveRelatorio(a),i=async a=>await g.deleteRelatorio(a),j=async a=>await g.getRelatorio(a),k=async()=>await g.listRelatorios(),l=async()=>await g.getStorageInfo(),m=async()=>await g.clearOldReports()}};