"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3372],{3361:(e,t,o)=>{o.d(t,{y1:()=>n,yM:()=>s});let r=o(5704).env.NEXT_PUBLIC_API_URL||"http://localhost:3001/api";class a{setToken(e){this.token=e}clearToken(){this.token=null}async request(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o="".concat(this.baseURL).concat(e),r={headers:{"Content-Type":"application/json",...t.headers},...t};this.token&&(r.headers.Authorization="Bearer ".concat(this.token));try{let e,t=await fetch(o,r),a=t.headers.get("content-type");if(e=a&&a.includes("application/json")?await t.json():await t.blob(),!t.ok)throw Error(e.error||"HTTP ".concat(t.status));return e}catch(e){throw console.error("Erro na requisi\xe7\xe3o:",e),e}}async get(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(e,{method:"GET",...t})}async post(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.request(e,{method:"POST",body:JSON.stringify(t),...o})}async put(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.request(e,{method:"PUT",body:JSON.stringify(t),...o})}async delete(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(e,{method:"DELETE",...t})}async uploadFile(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new FormData;r.append("file",t),Object.keys(o).forEach(e=>{r.append(e,o[e])});let a="".concat(this.baseURL).concat(e),i={method:"POST",body:r,headers:{}};this.token&&(i.headers.Authorization="Bearer ".concat(this.token));try{let e=await fetch(a,i),t=await e.json();if(!e.ok)throw Error(t.error||"HTTP ".concat(e.status));return t}catch(e){throw console.error("Erro no upload:",e),e}}async uploadMultipleFiles(e,t){let o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=new FormData;t.forEach(e=>{r.append("files",e)}),Object.keys(o).forEach(e=>{r.append(e,o[e])});let a="".concat(this.baseURL).concat(e),i={method:"POST",body:r,headers:{}};this.token&&(i.headers.Authorization="Bearer ".concat(this.token));try{let e=await fetch(a,i),t=await e.json();if(!e.ok)throw Error(t.error||"HTTP ".concat(e.status));return t}catch(e){throw console.error("Erro no upload m\xfaltiplo:",e),e}}constructor(){this.baseURL=r,this.token=null}}let i=new a,n={async login(e,t){let o=await i.post("/auth/login",{email:e,password:t});return o.token&&(i.setToken(o.token),localStorage.setItem("auth_token",o.token)),o},register:async e=>i.post("/auth/register",e),logout:async()=>(i.clearToken(),localStorage.removeItem("auth_token"),i.post("/auth/logout")),getProfile:async()=>i.get("/auth/profile"),updateProfile:async e=>i.put("/auth/profile",e),changePassword:async e=>i.put("/auth/change-password",e),initToken(){let e=localStorage.getItem("auth_token");e&&i.setToken(e)}},s={async list(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=new URLSearchParams;Object.keys(e).forEach(o=>{void 0!==e[o]&&null!==e[o]&&t.append(o,e[o])});let o=t.toString()?"?".concat(t.toString()):"";return i.get("/relatorios".concat(o))},getById:async e=>i.get("/relatorios/".concat(e)),create:async e=>i.post("/relatorios",e),update:async(e,t)=>i.put("/relatorios/".concat(e),t),delete:async e=>i.delete("/relatorios/".concat(e)),generatePDF:async e=>i.post("/relatorios/".concat(e,"/generate-pdf")),downloadPDF:async(e,t)=>i.get("/relatorios/".concat(e,"/pdf/").concat(t))}},3372:(e,t,o)=>{o.d(t,{UB:()=>d,gI:()=>h,ly:()=>l,wt:()=>s,y8:()=>c,y_:()=>u});var r=o(3361);class a{async init(){try{if(!localStorage.getItem("auth_token")){console.warn("⚠️ Nenhum token de autentica\xe7\xe3o encontrado, usando armazenamento local"),this.useBackend=!1,await this.localStorage.init();return}console.log("\uD83D\uDD04 Tentando conectar ao backend PostgreSQL..."),await r.yM.list(),this.useBackend=!0,console.log("✅ Usando backend PostgreSQL para armazenamento")}catch(e){console.error("❌ Erro ao conectar com backend:",e),console.warn("⚠️ Backend n\xe3o dispon\xedvel, usando armazenamento local"),this.useBackend=!1,await this.localStorage.init()}}async saveRelatorio(e){if(console.log("\uD83D\uDCBE Tentando salvar relat\xf3rio:",e.title),console.log("\uD83D\uDD27 Usando backend?",this.useBackend),!this.useBackend)return console.log("\uD83D\uDCBE Salvando localmente (IndexedDB)..."),await this.localStorage.saveRelatorio(e);try{console.log("\uD83D\uDCE4 Enviando para backend PostgreSQL...");let t=this.convertToBackendFormat(e);console.log("\uD83D\uDCCB Dados convertidos:",t);let o=await r.yM.create(t);return console.log("✅ Relat\xf3rio salvo no backend:",o),this.convertFromBackendFormat(o)}catch(t){return console.error("❌ Erro ao salvar no backend:",t),console.log("\uD83D\uDD04 Tentando fallback para local..."),await this.localStorage.saveRelatorio(e)}}async getRelatorio(e){if(!this.useBackend)return await this.localStorage.getRelatorio(e);try{let t=await r.yM.getById(e);return this.convertFromBackendFormat(t)}catch(t){return console.error("Erro ao buscar no backend:",t),await this.localStorage.getRelatorio(e)}}async getAllRelatorios(){if(!this.useBackend)return await this.localStorage.getAllRelatorios();try{return(await r.yM.list()).relatorios.map(e=>this.convertFromBackendFormat(e))}catch(e){return console.error("Erro ao listar do backend:",e),await this.localStorage.getAllRelatorios()}}async deleteRelatorio(e){if(this.useBackend)try{await r.yM.delete(e)}catch(t){console.error("Erro ao deletar no backend:",t),await this.localStorage.deleteRelatorio(e)}else await this.localStorage.deleteRelatorio(e)}async listRelatorios(){if(console.log("\uD83D\uDCCB Listando relat\xf3rios..."),console.log("\uD83D\uDD27 Usando backend?",this.useBackend),!this.useBackend)return console.log("\uD83D\uDCE5 Buscando localmente (IndexedDB)..."),await this.localStorage.listRelatorios();try{console.log("\uD83D\uDCE5 Buscando do backend PostgreSQL...");let e=await r.yM.list();return console.log("✅ Relat\xf3rios encontrados no backend:",e.relatorios.length),e.relatorios.map(e=>this.convertToReportSummary(e))}catch(e){return console.error("❌ Erro ao buscar no backend:",e),await this.localStorage.listRelatorios()}}async getStorageInfo(){if(!this.useBackend)return await this.localStorage.getStorageInfo();try{return{documentCount:(await r.yM.list()).pagination.total,maxCapacity:"Ilimitado (Backend)",availableCapacity:"Ilimitado (Backend)",usedCapacity:"N/A",percentage:0,storageType:"Backend PostgreSQL"}}catch(e){return console.error("Erro ao obter info do backend:",e),await this.localStorage.getStorageInfo()}}async clearOldReports(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;this.useBackend?console.log("Backend gerencia automaticamente o armazenamento"):await this.localStorage.clearOldReports(e)}convertToBackendFormat(e){return{tipo_servico:e.tipoServico,titulo:this.getTitle(e),data_relatorio:this.getDate(e),sub_regiao:this.getSubRegiao(e),local:this.getLocal(e),descricao:this.getDescription(e),dados_jsonb:e}}convertFromBackendFormat(e){return e.dados_jsonb||e}convertToReportSummary(e){let t=this.convertFromBackendFormat(e);return{id:e.id,title:e.titulo||this.getTitle(t),data:e.data_relatorio||this.getDate(t),fotoCount:this.countPhotos(t),tipoServico:e.tipo_servico,sub:e.sub_regiao,endereco:e.local||""}}getTitle(e){return"MUTIRAO"===e.tipoServico?e.title||"Mutir\xe3o":e.tipoServico}getDate(e){if("MUTIRAO"===e.tipoServico);else if("ROTINEIROS"===e.tipoServico);else if("REVITALIZACAO"===e.tipoServico);else if("ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico)return e.dataInicio||"";else if("DDS"===e.tipoServico)return e.dataInicio||"";else if("EVENTOS"===e.tipoServico)return e.dataInicio||"";return e.data||""}getSubRegiao(e){if("MUTIRAO"===e.tipoServico){var t,o;return(null==(o=e.secoes)||null==(t=o[0])?void 0:t.sub)||""}if("ROTINEIROS"===e.tipoServico)return e.sub||"";if("REVITALIZACAO"===e.tipoServico)return e.sub||"";if("ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico)return e.sub||"";if("DDS"===e.tipoServico)return e.sub||"";else if("EVENTOS"===e.tipoServico)return e.sub||"";return""}getLocal(e){if("MUTIRAO"===e.tipoServico){var t,o;return(null==(o=e.secoes)||null==(t=o[0])?void 0:t.local)||""}if("REVITALIZACAO"===e.tipoServico)return e.local||"";if("ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico)return e.local||"";if("DDS"===e.tipoServico)return e.local||"";if("EVENTOS"===e.tipoServico)return e.local||"";return""}getDescription(e){if("MUTIRAO"===e.tipoServico){var t,o;return(null==(o=e.secoes)||null==(t=o[0])?void 0:t.descricao)||""}if("REVITALIZACAO"===e.tipoServico)return e.descricao||"";if("ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico)return e.descricao||"";if("DDS"===e.tipoServico)return e.descricao||"";if("EVENTOS"===e.tipoServico)return e.descricao||"";return""}countPhotos(e){var t,o,r,a,i,n;if("MUTIRAO"===e.tipoServico)return(null==(t=e.secoes)?void 0:t.reduce((e,t)=>{var o;return e+(null==(o=t.servicos)?void 0:o.reduce((e,t)=>{var o;return e+((null==(o=t.fotos)?void 0:o.length)||0)},0))+ +!!t.equipeFotoUrl+ +!!t.mapaFotoUrl},0))||0;if("ROTINEIROS"===e.tipoServico)return(null==(o=e.servicos)?void 0:o.reduce((e,t)=>{var o;return e+((null==(o=t.fotos)?void 0:o.length)||0)},0))||0;if("REVITALIZACAO"===e.tipoServico)return(null==(r=e.fotos)?void 0:r.length)||0;if("ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico)return(null==(a=e.fotos)?void 0:a.length)||0;if("DDS"===e.tipoServico)return(null==(i=e.fotos)?void 0:i.length)||0;else if("EVENTOS"===e.tipoServico)return(null==(n=e.fotos)?void 0:n.length)||0;return 0}constructor(){this.useBackend=!0,this.localStorage=new i}}class i{async init(){return new Promise((e,t)=>{let o=indexedDB.open(this.dbName,this.version);o.onerror=()=>t(o.error),o.onsuccess=()=>{this.db=o.result,e()},o.onupgradeneeded=e=>{let t=e.target.result;if(!t.objectStoreNames.contains("relatorios")){let e=t.createObjectStore("relatorios",{keyPath:"id"});e.createIndex("tipoServico","tipoServico",{unique:!1}),e.createIndex("createdAt","createdAt",{unique:!1}),e.createIndex("updatedAt","updatedAt",{unique:!1})}}})}async ensureDB(){return this.db||await this.init(),this.db}async saveRelatorio(e){let t=await this.ensureDB();return new Promise((o,r)=>{let a=t.transaction(["relatorios"],"readwrite").objectStore("relatorios").put({...e,updatedAt:Date.now()});a.onsuccess=()=>o(e),a.onerror=()=>r(a.error)})}async getRelatorio(e){let t=await this.ensureDB();return new Promise((o,r)=>{let a=t.transaction(["relatorios"],"readonly").objectStore("relatorios").get(e);a.onsuccess=()=>o(a.result||null),a.onerror=()=>r(a.error)})}async getAllRelatorios(){let e=await this.ensureDB();return new Promise((t,o)=>{let r=e.transaction(["relatorios"],"readonly").objectStore("relatorios").getAll();r.onsuccess=()=>t(r.result||[]),r.onerror=()=>o(r.error)})}async deleteRelatorio(e){let t=await this.ensureDB();return new Promise((o,r)=>{let a=t.transaction(["relatorios"],"readwrite").objectStore("relatorios").delete(e);a.onsuccess=()=>o(),a.onerror=()=>r(a.error)})}async listRelatorios(){return(await this.getAllRelatorios()).map(e=>{var t,o,r,a,i,n,s,c;let l="";l="MUTIRAO"===e.tipoServico?e.data||"":"ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico?e.dataInicio||"":"REVITALIZACAO"===e.tipoServico||"ROTINEIROS"===e.tipoServico?e.data||"":e.dataInicio||e.data||"";let u=0;"MUTIRAO"===e.tipoServico?u=(null==(t=e.secoes)?void 0:t.reduce((e,t)=>{var o;return e+(null==(o=t.servicos)?void 0:o.reduce((e,t)=>{var o;return e+((null==(o=t.fotos)?void 0:o.length)||0)},0))+ +!!t.equipeFotoUrl+ +!!t.mapaFotoUrl},0))||0:"ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico?u=(null==(o=e.fotos)?void 0:o.length)||0:"REVITALIZACAO"===e.tipoServico?u=(null==(r=e.fotos)?void 0:r.length)||0:"ROTINEIROS"===e.tipoServico&&(u=(null==(a=e.servicos)?void 0:a.reduce((e,t)=>{var o;return e+((null==(o=t.fotos)?void 0:o.length)||0)},0))||0);let d={id:e.id,title:{MUTIRAO:"Mutir\xe3o",ACUMULADOR:"Acumulador",ALAGAMENTOS:"Alagamentos",REVITALIZACAO:"Revitaliza\xe7\xe3o",ZELADORIA:"Zeladoria",DDS:"DDS",HIGIENIZACAO:"Higieniza\xe7\xe3o, manuten\xe7\xe3o, instala\xe7\xe3o, remo\xe7\xe3o e reposi\xe7\xe3o de Papeleiras",VARRICAO_MECANIZADA:"Varri\xe7\xe3o Mecanizada",FEIRAS:"Feiras",EVENTOS:"Eventos",ROTINEIROS:"Servi\xe7os Rotineiros",REGISTROS_FOTOGRAFICOS:"Registros Fotogr\xe1ficos"}[e.tipoServico]||e.tipoServico,data:l,createdAt:e.createdAt,updatedAt:e.updatedAt,fotoCount:u};return"MUTIRAO"===e.tipoServico?{...d,tipoServico:e.tipoServico,sub:null==(n=e.secoes)||null==(i=n[0])?void 0:i.sub,endereco:(null==(c=e.secoes)||null==(s=c[0])?void 0:s.local)||""}:"ACUMULADOR"===e.tipoServico||"ALAGAMENTOS"===e.tipoServico||"ZELADORIA"===e.tipoServico?{...d,tipoServico:e.tipoServico,sub:e.sub,endereco:e.local||""}:"REVITALIZACAO"===e.tipoServico?{...d,tipoServico:e.tipoServico,sub:e.sub,endereco:e.local||""}:"ROTINEIROS"===e.tipoServico?{...d,tipoServico:e.tipoServico,sub:e.sub,endereco:""}:{...d,tipoServico:e.tipoServico,endereco:""}})}async getStorageInfo(){let e=await this.ensureDB();return new Promise(t=>{let o=e.transaction(["relatorios"],"readonly").objectStore("relatorios").count();o.onsuccess=()=>{navigator.storage.estimate().then(e=>{t({documentCount:o.result,maxCapacity:0x80000000,availableCapacity:e.quota||0,usedCapacity:e.usage||0,percentage:Math.round((e.usage||0)/0x80000000*100),storageType:"Local (IndexedDB)"})})}})}async clearOldReports(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=await this.getAllRelatorios();if(t.length<=e)return;let o=t.sort((e,t)=>new Date(t.createdAt).getTime()-new Date(e.createdAt).getTime()).slice(e);for(let e of o)await this.deleteRelatorio(e.id);console.log("\uD83D\uDDD1️ Removidos ".concat(o.length," relat\xf3rios antigos"))}constructor(){this.dbName="RelatoriosDB",this.version=1,this.db=null}}let n=new a;setTimeout(()=>{n.init().catch(console.error)},1e3);let s=async e=>await n.saveRelatorio(e),c=async e=>await n.deleteRelatorio(e),l=async e=>await n.getRelatorio(e),u=async()=>await n.listRelatorios(),d=async()=>await n.getStorageInfo(),h=async()=>await n.clearOldReports()}}]);